datasource db {
  url      = env("DATABASE_URL")
  provider = "mongodb"
}

generator client {
  provider = "prisma-client-js"
}

// Votes
type Vote {
  email     String
  surveyId  String
  createdAt String
  response  String
}

type Option {
  emoji       String?
  title       String
  image       String?
  description String?
}

// 游 NEWSLETTER SYSTEM - Plugin-Ready Architecture
// Simple pero extractable para @fixtergeek/sequences plugin

enum NewsletterStatus {
  DRAFT
  SCHEDULED
  SENT
  CANCELLED
}

enum SequenceTrigger {
  SUBSCRIPTION    // Al suscribirse
  TAG_ADDED      // Al a침adir tag  
  MANUAL         // Inscripci칩n manual
  COURSE_PURCHASE // Tras comprar curso
}

// ============================
// EMAIL SEQUENCES (Core Feature)
// ============================

model Sequence {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String                    // "Bienvenida Claude Code"
  description String?                   // Descripci칩n interna
  
  // Trigger
  trigger     SequenceTrigger
  triggerTag  String?                   // Tag espec칤fico si trigger es TAG_ADDED
  
  // Estado
  isActive    Boolean @default(false)
  isFeatured  Boolean @default(false)    // Para destacar en la UI
  
  // Emails de la secuencia (ordenados)
  emails      SequenceEmail[]
  
  // Inscripciones de usuarios
  enrollments SequenceEnrollment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SequenceEmail {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  sequenceId String @db.ObjectId
  sequence   Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  
  // Orden y timing
  order        Int                      // 1, 2, 3, etc.
  
  // Dos formas de programar el env칤o:
  schedulingType String @default("delay") // "delay" | "specific_date"
  delayDays      Int?                     // D칤as a esperar (para schedulingType: "delay")
  specificDate   DateTime?                // Fecha/hora espec칤fica (para schedulingType: "specific_date")
  
  // Contenido
  subject    String                     // "춰Bienvenido a FixterGeek!"
  content    String                     // HTML del email
  
  // Configuraci칩n
  fromName   String @default("FixterGeek")
  fromEmail  String @default("contacto@fixter.org")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([sequenceId, order])
}

model SequenceEnrollment {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  sequenceId   String @db.ObjectId
  sequence     Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  
  subscriberId String @db.ObjectId
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  
  // Estado actual
  status           String    @default("active")  // active, completed, paused
  currentEmailIndex Int      @default(0)         // Qu칠 email sigue
  nextEmailAt      DateTime?                     // Cu치ndo enviar el siguiente
  
  // Tracking b치sico
  enrolledAt       DateTime  @default(now())
  completedAt      DateTime?
  emailsSent       Int       @default(0)
  
  @@unique([sequenceId, subscriberId])           // Un usuario solo puede estar una vez en cada secuencia
  @@index([status, nextEmailAt])                 // Para encontrar emails a enviar
}

// ============================
// NEWSLETTER SIMPLIFICADO 
// ============================

model Newsletter {
  id     String           @id @default(auto()) @map("_id") @db.ObjectId
  title  String
  slug   String?          @unique
  status NewsletterStatus @default(DRAFT)
  
  // Contenido b치sico
  subject    String?
  content    String?
  
  // Configuraci칩n
  fromName   String? @default("FixterGeek")
  fromEmail  String? @default("contacto@fixter.org")
  
  // Programaci칩n
  scheduledAt DateTime?
  sentAt      DateTime?
  
  // Backward compatibility
  messageIds String[]
  delivered  String[]
  opened     String[]
  clicked    String[]
  recipients String[]
  userId     String?   @db.ObjectId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status])
}

// model Survey {
//   id          String   @id @default(auto()) @map("_id") @db.ObjectId
//   slug        String   @unique
//   description String?
//   title       String?
//   options     Option[]
//   votes       Vote[]
//   totals      Json?
// }

//generator zod {
//  provider = "prisma-zod-generator"
//  output   = "./zod"
//}

type LocalVideo {
  src         String
  cover       String?
  description String?
  title       String
}

type Author {
  name  String?
  image String?
}

// ============================
// SUSCRIPTORES AVANZADOS  
// ============================

model Subscriber {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  email String @unique
  
  // Informaci칩n personal
  firstName   String?
  lastName    String?
  name        String?        // Backward compatibility
  avatar      String?
  
  // Campos personalizados ilimitados
  customFields Json?
  
  // Estado y confirmaci칩n
  confirmed     Boolean          @default(false)
  confirmedAt   DateTime?
  validToken    Boolean          @default(true)  // Backward compatibility

  // OTP verification
  verificationCode  String?
  codeExpiresAt     DateTime?

  // Segmentaci칩n simple
  tags              String[]
  
  // Sequences relation
  sequenceEnrollments SequenceEnrollment[]
  
  // Backward compatibility with tutorials
  tutorialIds String[]   @db.ObjectId
  tutorials   Tutorial[] @relation(fields: [tutorialIds], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([tags])
}

model Tutorial {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  slug        String   @unique
  lessons     Lesson[]
  icon        String?
  published   Boolean? @default(false)
  description String?
  author      Author?
  codeLink    String?
  poster      String?

  subscriberIds String[]     @db.ObjectId
  subscribers   Subscriber[] @relation(fields: [subscriberIds], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lesson {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  body        String?
  isFirst     Boolean      @default(false)
  title       String
  slug        String       @unique
  videos      LocalVideo[]
  tutorial    Tutorial     @relation(fields: [tutorialId], references: [id])
  tutorialId  String       @db.ObjectId
  index       Int?
  codesandbox String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

type Banner {
  img  String
  link String
}

model Post {
  // Basic fields
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  // Unique fields
  slug  String @unique
  title String @unique

  // defaults
  published Boolean @default(false)

  // Miscelanius
  coverImage   String?
  body         String?
  authorAt     String?
  photoUrl     String?
  isFeatured   Boolean? @default(false)
  metaImage    String?
  youtubeLink  String?
  authorAtLink String?

  // Filtering
  authorName String?
  mainTag    String?
  tags       String[]
  category   String[]
  banner     Banner?

  // Relations
  audioCache AudioCache?
}

model Course {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  slug              String    @unique
  title             String
  isFree            Boolean   @default(true)
  published         Boolean?  @default(false)
  basePrice         Int       @default(599)
  // videos
  videos            Video[]   @relation(fields: [videoIds], references: [id])
  videoIds          String[]  @db.ObjectId
  // stripe
  stripeCoupon      String?
  stripeId          String?
  // optionals
  icon              String?
  poster            String?
  isLive            Boolean   @default(false)
  summary           String?
  authorAt          String?
  authorDescription String?
  authorName        String?
  authorSocial      String?
  banner            String?
  classTime         String?
  description       String?
  duration          String?
  level             String?
  logos             String?
  meta              String?
  offer             String?   @db.ObjectId
  photoUrl          String?
  tipo              String?
  tool              String?
  trailer           String?
  version           String?
  theme             Json?
  v                 Int?      @map("__v")
  // dates
  startDate         DateTime? @db.Date
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  // arrays
  module            Json?
  Modules           Module[]
  modules           String[]  @db.ObjectId
  // relations aug 2023
  Users             User[]    @relation(fields: [userIds], references: [id])
  userIds           String[]  @db.ObjectId

  @@map("courses")
}

model Module {
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  v         Int?     @map("__v")

  title String
  slug  String?

  Course Course? @relation(fields: [course], references: [id])
  course String? @db.ObjectId

  Video Video[]
}

model Video {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  slug        String   @unique
  title       String
  isPublic    Boolean  @default(false)
  accessLevel String   @default("paid") // "public" | "subscriber" | "paid"
  //optionals
  moduleName  String?
  storageLink String?
  m3u8        String?
  youtubeUrl  String?  // URL de YouTube (alternativa a S3)
  index       Int?
  authorName  String?  @default("blissmo")
  photoUrl    String?
  description String?
  duration    String?  @default("0") // prefer mins
  poster      String?
  module      String?  @db.ObjectId
  Module      Module?  @relation(fields: [module], references: [id])
  // moduleId String? @db.ObjectId
  // Module    Module?  @relation(fields: [module], references: [id])
  // experiment aug 2023
  courses     Course[] @relation(fields: [courseIds], references: [id])
  courseIds   String[] @db.ObjectId
  v           Int?     @map("__v")
  
  // Video processing status
  processingStatus      String?   // "pending", "processing", "ready", "failed"
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  processingFailedAt    DateTime?
  processingError       String?
  processingMetadata    Json?     // Store quality info, processing time, etc.
  
  //dates
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("videos")
}

model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  v           Int?     @map("__v")
  accessToken String?
  /// Multiple data types found: Array(String (ObjectId)): 98.7%, Array(Unknown): 1.3% out of 864 sampled entries
  bootcamps   Json?
  changePass  Boolean?
  confirmed   Boolean  @default(false)
  /// Multiple data types found: Array(String): 5.3%, Array(String (ObjectId)): 94.7% out of 334 sampled entries
  courses     String[] @db.ObjectId
  Courses     Course[] @relation(fields: [courses], references: [id])
  displayName String?
  editions    String[] @db.ObjectId
  email       String   @unique
  /// Could not determine type: the field only had null or empty values in the sample set.
  enrolled    Json?
  exams       Json?
  facebookId  String?
  googleId    String?
  hash        String?
  homeworks   Json?
  mentoring   Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  models      Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  modules     Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  payments    Json?
  phoneNumber String?
  photoURL    String?
  providerId  String?
  role        String?  @default("GUEST")
  roles       String[]
  salt        String?
  uid         String?
  username    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  /// Could not determine type: the field only had null or empty values in the sample set.
  videos      Json?
  // 2025
  tags        String[]
  metadata    Json?
  webinar     Json? // Informaci칩n del webinar con las 3 preguntas
  books       String[] // Libros comprados: ["ai-sdk", "domina-claude-code", "llamaindex"]

  @@map("users")
}

// Control de acceso por cap칤tulo de libro
model BookChapterAccess {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  bookSlug    String // "domina-claude-code", "ai-sdk", "llamaindex"
  chapterSlug String // "prologo", "capitulo-01", etc.
  accessLevel String @default("public") // "public" | "subscriber" | "paid"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([bookSlug, chapterSlug])
  @@map("book_chapter_access")
}

model AudioCache {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  postId      String   @unique @db.ObjectId
  s3Key       String // S3 object key
  audioUrl    String // Pre-signed URL or CloudFront URL
  duration    Int // in seconds
  fileSize    Int // in bytes
  cost        Float? // generation cost in USD
  generatedBy String?  @db.ObjectId // User who generated the audio
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  post Post @relation(fields: [postId], references: [id])
}

model AudioAnalytics {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  postId       String   @db.ObjectId
  event        String // 'generate', 'play', 'pause', 'complete'
  timestamp    DateTime @default(now())
  sessionId    String?
  userAgent    String?
  playDuration Int? // for play events
}

model BlogAnalytics {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  postId    String   @db.ObjectId
  sessionId String // Anonymous session identifier
  event     String // 'page_view', 'scroll', 'read_time', 'text_select', 'copy', 'click'
  timestamp DateTime @default(now())
  userId    String?  @db.ObjectId // Optional user ID for authenticated users

  // Reading behavior
  readingTime    Int? // seconds spent reading
  scrollDepth    Float? // percentage of page scrolled (0-100)
  completionRate Float? // estimated reading completion (0-100)

  // Interaction data
  elementClicked String? // CSS selector or element ID
  textSelected   String? // selected text (first 100 chars)

  // Heatmap coordinates (normalized percentages)
  clickX  Float? // X coordinate as percentage (0-100)
  clickY  Float? // Y coordinate as percentage (0-100)
  scrollY Float? // Scroll position when click occurred

  // Viewport context for responsive heatmaps
  viewportWidth  Int? // Browser viewport width
  viewportHeight Int? // Browser viewport height
  contentWidth   Int? // Content container width
  contentHeight  Int? // Content container height

  // Technical data
  userAgent String?
  referrer  String?

  // Privacy-safe metadata
  country    String? // from IP geolocation
  deviceType String? // mobile, tablet, desktop
  metadata   Json? // Additional metadata as JSON
}

// Aggregated heatmap data for performance
model HeatmapData {
  id     String   @id @default(auto()) @map("_id") @db.ObjectId
  postId String   @db.ObjectId
  date   DateTime @db.Date // Daily aggregation

  // Heatmap points (JSON array of {x, y, intensity, element})
  clickPoints  Json // Aggregated click coordinates
  scrollPoints Json // Scroll depth distribution

  // Aggregation metadata
  totalClicks    Int
  uniqueSessions Int
  avgScrollDepth Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([postId, date])
}

// Suppression list - emails que nunca deben recibir correos
model EmailBlacklist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  reason    String   // "hard_bounce", "complaint", "manual"
  details   String?  // Diagn칩stico de SES
  createdAt DateTime @default(now())

  @@map("email_blacklist")
}

// Video analytics - tracking minimalista de visualizaciones
model VideoView {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  videoId       String    @db.ObjectId
  videoSlug     String
  courseId      String?   @db.ObjectId

  // Identificaci칩n flexible
  userId        String?   @db.ObjectId  // Si est치 autenticado
  email         String?                  // Para an치lisis sin auth
  sessionId     String                   // Siempre presente (an칩nimos)

  // M칠tricas clave
  startedAt     DateTime  @default(now())
  completedAt   DateTime?                // null = no termin칩
  watchedSeconds Int      @default(0)    // Tiempo real visto
  videoDuration  Int?                    // Duraci칩n total del video

  // Contexto 칰til
  deviceType    String?                  // mobile/tablet/desktop

  @@index([videoId])
  @@index([courseId])
  @@index([userId])
  @@index([startedAt])
  @@map("video_views")
}

// Course ratings - Sistema de social proof
model CourseRating {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  userId      String?  @db.ObjectId
  email       String

  rating      Int                    // 1-5 estrellas
  comment     String?                // Testimonial opcional
  displayName String?                // Nombre a mostrar (opcional)
  title       String?                // T칤tulo/rol del usuario (ej: "Desarrollador", "Estudiante")
  avatarUrl   String?                // Avatar en base64

  approved    Boolean  @default(false)
  featured    Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@unique([courseId, email])        // Un rating por persona por curso
  @@index([courseId, approved])
  @@map("course_ratings")
}
